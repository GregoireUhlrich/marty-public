// This file is part of MARTY.
//
// MARTY is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// MARTY is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with MARTY. If not, see <https://www.gnu.org/licenses/>.

 # Part common to all libraries generated by CSL

CC     = gcc -std=c++17
CFLAGS = -O3 -Wall -Wextra -Wpedantic -Wno-deprecated-declarations -fPIC -DQUADRUPLE_TYPE_DIAG -DQUAD

SRCDIR = src
INCDIR = include
OBJDIR = obj
SCRIPTDIR = script
SOBJDIR = script/obj
BINDIR = bin
LIBDIR = lib

SRC 	 = $(wildcard $(SRCDIR)/*.cpp)
HEADERS  = $(wildcard $(INCDIR)/*.h)
OBJ_INIT = $(SRC:$(SRCDIR)/%.cpp=$(OBJDIR)/%.o)
OBJ 	 = $(filter-out $(OBJDIR)/$(NAME)_pylink.o, $(OBJ_INIT))
SCRIPTS  = $(wildcard $(SCRIPTDIR)/*.cpp)
BINARIES = $(SCRIPTS:$(SCRIPTDIR)/%.cpp=%.x)

SOBJ = $(SCRIPTS:$(SCRIPTDIR)/%.cpp=$(SOBJDIR)/%.o)

all: scripts lib

scripts: $(BINARIES)
lib: $(NAMELIB).so $(NAMELIB).a

$(OBJDIR)/%.o: $(SRCDIR)/%.cpp $(HEADERS)
	$(CC) $(CFLAGS) -c $< -o $@ $(INCPATH)

$(SOBJDIR)/%.o: $(SCRIPTDIR)/%.cpp
	$(CC) $(CFLAGS) -c $< -o $@ $(INCPATH)

%.x: $(SOBJDIR)/%.o $(OBJ)
	$(CC) $(CFLAGS) -o $(BINDIR)/$@ $< $(OBJ) $(INCPATH) $(LIBPATH) $(LIBS)

$(NAMELIB).so: $(OBJ)
	$(CC) $(CFLAGS) -shared -o $(LIBDIR)/$@ $(OBJ)
$(NAMELIB).a: $(OBJ)
	ar rcsU $(LIBDIR)/$@ $(OBJ)

clean:
	rm $(OBJDIR)/*.o
Clean:
	$(MAKE) clean
	rm $(BINDIR)/*.x
